<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Social Media App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fafafa}
header{background:#fff;border-bottom:1px solid #ddd;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;font-weight:bold}
.container{max-width:600px;margin:auto;padding:10px}
.card{background:#fff;border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:12px}
.hidden{display:none}
.profile{display:flex;gap:12px;align-items:center}
.dp{width:64px;height:64px;border-radius:50%;background:#ddd}
.btn{padding:7px 10px;border-radius:6px;border:none;cursor:pointer}
.primary{background:#0095f6;color:#fff}
.danger{background:#ef4444;color:#fff}
.ghost{background:#eee}
.post h4{margin:0 0 4px}
.actions{display:flex;gap:12px;margin-top:6px}
.like{cursor:pointer;color:#555}
.like.active{color:#e11d48;font-weight:bold}
.follow{margin-left:auto}
.comment{font-size:14px;margin:4px 0}
input,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
small{color:#777}
</style>
</head>

<body>

<header>
  üî• My Social Media App
  <button id="logoutBtn" class="btn danger hidden">Logout</button>
</header>

<div class="container">

<!-- LOGIN -->
<div id="loginCard" class="card">
  <button id="loginBtn" class="btn primary">Login with Google</button>
</div>

<!-- PROFILE -->
<div id="profileCard" class="card hidden">
  <div class="profile">
    <div class="dp"></div>
    <div>
      <b id="meName"></b><br>
      <small>
        <span id="followerCount">0</span> followers ¬∑
        <span id="followingCount">0</span> following
      </small>
    </div>
  </div>
</div>

<!-- CREATE POST -->
<div id="postCard" class="card hidden">
  <textarea id="postText" placeholder="What's on your mind?"></textarea>
  <button class="btn primary" onclick="addPost()">Post</button>
</div>

<!-- POSTS -->
<div id="posts"></div>

</div>

<script>
/* üî• FIREBASE CONFIG (YOURS) */
const firebaseConfig = {
  apiKey: "AIzaSyBUfFcZuhV8-vmN9TYvSoe3ZzXHvn_gZwA",
  authDomain: "chat-room-e55bf.firebaseapp.com",
  projectId: "chat-room-e55bf",
  storageBucket: "chat-room-e55bf.firebasestorage.app",
  messagingSenderId: "653408545862",
  appId: "1:653408545862:web:c3c04443d67a55f0a6ae47"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const provider = new firebase.auth.GoogleAuthProvider();

/* ELEMENTS */
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginCard = document.getElementById("loginCard");
const profileCard = document.getElementById("profileCard");
const postCard = document.getElementById("postCard");
const postsDiv = document.getElementById("posts");
const meName = document.getElementById("meName");
const followerCount = document.getElementById("followerCount");
const followingCount = document.getElementById("followingCount");

/* AUTH */
loginBtn.onclick = ()=> auth.signInWithPopup(provider);
logoutBtn.onclick = ()=> auth.signOut();

auth.onAuthStateChanged(async user=>{
  if(user){
    loginCard.classList.add("hidden");
    profileCard.classList.remove("hidden");
    postCard.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    meName.innerText = user.displayName;

    // ensure user doc
    const uref = db.collection("users").doc(user.uid);
    const usnap = await uref.get();
    if(!usnap.exists){
      await uref.set({name:user.displayName, followers:[], following:[]});
    }
    listenProfile();
    listenPosts();
  }else{
    loginCard.classList.remove("hidden");
    profileCard.classList.add("hidden");
    postCard.classList.add("hidden");
    logoutBtn.classList.add("hidden");
    postsDiv.innerHTML="";
  }
});

/* PROFILE COUNTS */
function listenProfile(){
  const uid = auth.currentUser.uid;
  db.collection("users").doc(uid).onSnapshot(s=>{
    const d=s.data();
    followerCount.innerText = d.followers.length;
    followingCount.innerText = d.following.length;
  });
}

/* ADD POST */
function addPost(){
  const text = postText.value.trim();
  if(!text) return;
  db.collection("posts").add({
    text,
    uid: auth.currentUser.uid,
    name: auth.currentUser.displayName,
    likes: [],
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  postText.value="";
}

/* FOLLOW / UNFOLLOW */
async function toggleFollow(targetUid){
  const me = auth.currentUser.uid;
  const myRef = db.collection("users").doc(me);
  const tRef = db.collection("users").doc(targetUid);
  const mySnap = await myRef.get();
  const following = mySnap.data().following.includes(targetUid);
  if(following){
    await myRef.update({following: firebase.firestore.FieldValue.arrayRemove(targetUid)});
    await tRef.update({followers: firebase.firestore.FieldValue.arrayRemove(me)});
  }else{
    await myRef.update({following: firebase.firestore.FieldValue.arrayUnion(targetUid)});
    await tRef.update({followers: firebase.firestore.FieldValue.arrayUnion(me)});
  }
}

/* LIKE / UNLIKE (per user) */
async function toggleLike(postId){
  const uid = auth.currentUser.uid;
  const pref = db.collection("posts").doc(postId);
  const snap = await pref.get();
  const liked = snap.data().likes.includes(uid);
  await pref.update({
    likes: liked
      ? firebase.firestore.FieldValue.arrayRemove(uid)
      : firebase.firestore.FieldValue.arrayUnion(uid)
  });
}

/* COMMENTS */
function addComment(postId){
  const inp = document.getElementById("c_"+postId);
  const text = inp.value.trim();
  if(!text) return;
  db.collection("posts").doc(postId).collection("comments").add({
    text,
    uid: auth.currentUser.uid,
    name: auth.currentUser.displayName,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  inp.value="";
}

/* POSTS LISTENER */
function listenPosts(){
  db.collection("posts").orderBy("time","desc").onSnapshot(snap=>{
    postsDiv.innerHTML="";
    snap.forEach(doc=>{
      const p = doc.data();
      const me = auth.currentUser.uid;
      const liked = p.likes.includes(me);
      postsDiv.innerHTML += `
      <div class="card post">
        <h4>${p.name}</h4>
        <p>${p.text}</p>
        <div class="actions">
          <span class="like ${liked?'active':''}" onclick="toggleLike('${doc.id}')">
            ‚ù§Ô∏è ${p.likes.length}
          </span>
          ${p.uid!==me?`<button class="btn ghost follow" onclick="toggleFollow('${p.uid}')">Follow</button>`:''}
        </div>
        <div>
          <input id="c_${doc.id}" placeholder="Add a comment">
          <button class="btn ghost" onclick="addComment('${doc.id}')">Comment</button>
          <div id="cm_${doc.id}"></div>
        </div>
      </div>`;
      // comments
      db.collection("posts").doc(doc.id).collection("comments")
        .orderBy("time","asc")
        .onSnapshot(cs=>{
          const box = document.getElementById("cm_"+doc.id);
          box.innerHTML="";
          cs.forEach(c=>{
            const x=c.data();
            box.innerHTML += `<div class="comment"><b>${x.name}:</b> ${x.text}</div>`;
          });
        });
    });
  });
}
</script>

</body>
</html>
