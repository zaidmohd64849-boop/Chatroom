<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mini Instagram</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fafafa}
header{background:#fff;padding:10px;border-bottom:1px solid #ddd;
display:flex;justify-content:space-between;align-items:center;font-weight:bold}
.container{max-width:600px;margin:auto;padding:10px;padding-bottom:70px}
.card{background:#fff;border-radius:12px;border:1px solid #ddd;padding:12px;margin-bottom:12px}
.hidden{display:none}
.btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer}
.primary{background:#0095f6;color:#fff}
.danger{background:#ef4444;color:#fff}
.ghost{background:#eee}
.avatar{width:70px;height:70px;border-radius:50%;background:#ddd;
display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:bold}
input,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
.postActions{display:flex;gap:12px;align-items:center}
.like{cursor:pointer}
.like.active{color:#e11d48;font-weight:bold}
.comment{font-size:14px;margin:4px 0}
.userRow{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
.chatBox{height:260px;overflow:auto;border:1px solid #ddd;padding:6px;margin:6px 0}
.msg{margin:4px 0}
.me{text-align:right}
small{color:#777}

/* Bottom Nav */
.nav{
position:fixed;bottom:0;left:0;right:0;
background:#fff;border-top:1px solid #ddd;
display:flex;justify-content:space-around;padding:8px 0}
.nav div{cursor:pointer;font-size:14px}
.nav .active{font-weight:bold;color:#0095f6}
</style>
</head>

<body>

<header>
üì∏ Mini Instagram
<button id="logoutBtn" class="btn danger hidden">Logout</button>
</header>

<div class="container">

<!-- LOGIN -->
<div id="loginCard" class="card">
<button id="loginBtn" class="btn primary">Login with Google</button>
</div>

<!-- HOME -->
<div id="homePage" class="hidden">
<div class="card">
<textarea id="postText" placeholder="What's on your mind?"></textarea>
<button class="btn primary" onclick="addPost()">Post</button>
</div>
<div id="posts"></div>
</div>

<!-- SEARCH -->
<div id="searchPage" class="hidden">
<div class="card">
<input id="searchInput" placeholder="Search users">
<div id="searchResults"></div>
</div>
</div>

<!-- CHAT -->
<div id="chatPage" class="hidden">
<div class="card">
<b>Live Chat</b>
<input id="chatUid" placeholder="Enter User UID">
<div class="chatBox" id="chatBox"></div>
<input id="chatMsg" placeholder="Message">
<button class="btn primary" onclick="sendMsg()">Send</button>
</div>
</div>

<!-- PROFILE -->
<div id="profilePage" class="hidden">
<div class="card">
<div style="display:flex;gap:12px;align-items:center">
<div class="avatar" id="avatar"></div>
<div>
<b id="myName"></b><br>
<small>
<span id="followers">0</span> followers ¬∑
<span id="following">0</span> following
</small>
</div>
</div>
<textarea id="bio" placeholder="Write bio"></textarea>
<button class="btn ghost" onclick="saveBio()">Save Bio</button>
</div>
</div>

</div>

<!-- BOTTOM NAV -->
<div class="nav hidden" id="bottomNav">
<div onclick="showPage('homePage',this)" class="active">üè† Home</div>
<div onclick="showPage('searchPage',this)">üîç Search</div>
<div onclick="showPage('chatPage',this)">üí¨ Chat</div>
<div onclick="showPage('profilePage',this)">üë§ Profile</div>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyBUfFcZuhV8-vmN9TYvSoe3ZzXHvn_gZwA",
authDomain:"chat-room-e55bf.firebaseapp.com",
projectId:"chat-room-e55bf",
storageBucket:"chat-room-e55bf.firebasestorage.app",
messagingSenderId:"653408545862",
appId:"1:653408545862:web:c3c04443d67a55f0a6ae47"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();
const provider=new firebase.auth.GoogleAuthProvider();

loginBtn.onclick=()=>auth.signInWithPopup(provider);
logoutBtn.onclick=()=>auth.signOut();

/* NAV */
function showPage(id,el){
document.querySelectorAll(".container > div").forEach(d=>d.classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
document.querySelectorAll(".nav div").forEach(n=>n.classList.remove("active"));
el.classList.add("active");
}

/* AUTH */
auth.onAuthStateChanged(async user=>{
if(user){
loginCard.classList.add("hidden");
homePage.classList.remove("hidden");
bottomNav.classList.remove("hidden");
logoutBtn.classList.remove("hidden");

myName.innerText=user.displayName;
avatar.innerText=user.displayName.charAt(0);

const u=db.collection("users").doc(user.uid);
if(!(await u.get()).exists){
u.set({name:user.displayName,bio:"",followers:[],following:[]});
}
u.onSnapshot(s=>{
followers.innerText=s.data().followers.length;
following.innerText=s.data().following.length;
bio.value=s.data().bio;
});
listenPosts();
}
});

/* BIO */
function saveBio(){
db.collection("users").doc(auth.currentUser.uid).update({bio:bio.value});
}

/* SEARCH */
searchInput.oninput=async()=>{
searchResults.innerHTML="";
if(!searchInput.value)return;
const snap=await db.collection("users").get();
snap.forEach(d=>{
if(d.id!==auth.currentUser.uid &&
d.data().name.toLowerCase().includes(searchInput.value.toLowerCase())){
searchResults.innerHTML+=`
<div class="userRow">
${d.data().name}
<button class="btn ghost" onclick="toggleFollow('${d.id}')">Follow</button>
</div>`;
}
});
};

async function toggleFollow(uid){
const me=auth.currentUser.uid;
const my=db.collection("users").doc(me);
const t=db.collection("users").doc(uid);
const s=await my.get();
if(s.data().following.includes(uid)){
my.update({following:firebase.firestore.FieldValue.arrayRemove(uid)});
t.update({followers:firebase.firestore.FieldValue.arrayRemove(me)});
}else{
my.update({following:firebase.firestore.FieldValue.arrayUnion(uid)});
t.update({followers:firebase.firestore.FieldValue.arrayUnion(me)});
}
}

/* POSTS */
function addPost(){
if(!postText.value.trim())return;
db.collection("posts").add({
text:postText.value,
uid:auth.currentUser.uid,
name:auth.currentUser.displayName,
likes:[],
time:firebase.firestore.FieldValue.serverTimestamp()
});
postText.value="";
}

function listenPosts(){
db.collection("posts").orderBy("time","desc").onSnapshot(s=>{
posts.innerHTML="";
s.forEach(doc=>{
const p=doc.data();
const me=auth.currentUser.uid;
posts.innerHTML+=`
<div class="card">
<b>${p.name}</b>
<p>${p.text}</p>
<div class="postActions">
<span class="like ${p.likes.includes(me)?'active':''}"
onclick="toggleLike('${doc.id}')">‚ù§Ô∏è ${p.likes.length}</span>
${p.uid===me?`<button class="btn danger"
onclick="deletePost('${doc.id}')">Delete</button>`:''}
</div>
</div>`;
});
});
}

function toggleLike(id){
const ref=db.collection("posts").doc(id);
ref.get().then(s=>{
ref.update({
likes:s.data().likes.includes(auth.currentUser.uid)
?firebase.firestore.FieldValue.arrayRemove(auth.currentUser.uid)
:firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid)
});
});
}

function deletePost(id){
db.collection("posts").doc(id).delete();
}

/* CHAT */
function sendMsg(){
const to=chatUid.value;
if(!to||!chatMsg.value)return;
const chatId=[auth.currentUser.uid,to].sort().join("_");
db.collection("chats").doc(chatId).collection("msgs").add({
from:auth.currentUser.uid,
text:chatMsg.value,
time:Date.now()
});
chatMsg.value="";
loadChat();
}

function loadChat(){
const to=chatUid.value;
if(!to)return;
const chatId=[auth.currentUser.uid,to].sort().join("_");
db.collection("chats").doc(chatId).collection("msgs")
.orderBy("time").onSnapshot(s=>{
chatBox.innerHTML="";
s.forEach(m=>{
const x=m.data();
chatBox.innerHTML+=`
<div class="msg ${x.from===auth.currentUser.uid?'me':''}">
${x.text}
</div>`;
});
});
}
</script>

</body>
</html>
