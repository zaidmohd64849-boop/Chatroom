<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Clone</title>

<style>
body{margin:0;font-family:system-ui;background:#ece5dd}
header{
  background:#075e54;color:white;
  padding:10px;display:flex;align-items:center;gap:10px
}
#back{cursor:pointer;font-size:20px}
.container{padding:10px}
.user{
  background:white;padding:10px;border-radius:10px;
  margin-bottom:6px;cursor:pointer
}
.name{font-weight:600}
.status{font-size:12px;color:gray}

#chat{display:none;height:100vh;flex-direction:column}
#messages{flex:1;overflow-y:auto;padding:10px}
.msg{
  max-width:70%;padding:8px 12px;
  border-radius:10px;margin-bottom:6px
}
.me{background:#dcf8c6;margin-left:auto}
.other{background:white}
.msg span{float:right;font-size:11px;margin-left:6px}

#typing{font-size:12px;color:gray;margin-left:10px}

#inputBar{
  display:flex;padding:6px;background:#f0f0f0
}
#inputBar input{
  flex:1;border:none;border-radius:20px;padding:10px
}
#inputBar button{
  background:#25d366;border:none;color:white;
  padding:10px 16px;border-radius:20px;margin-left:6px
}

.menu{
  position:absolute;right:10px;top:50px;
  background:white;border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,.2);
  display:none
}
.menu div{padding:10px;cursor:pointer}
.menu div:hover{background:#eee}
</style>
</head>

<body>

<header>
  <span id="back" onclick="closeChat()">â¬…</span>
  <div style="flex:1">
    <div id="chatName">Chats</div>
    <div id="typing"></div>
  </div>
  <span onclick="toggleMenu()">â‹®</span>
</header>

<div id="menu" class="menu">
  <div onclick="clearForMe()">ðŸ§¹ Clear for me</div>
  <div onclick="clearForAll()">ðŸš« Clear for everyone</div>
</div>

<!-- STATUS -->
<div class="container">
  <div class="user" onclick="addStatus()">
    <div class="name">âž• My Status</div>
    <div class="status">Tap to add status</div>
  </div>
  <div id="statusList"></div>
</div>

<!-- USERS -->
<div id="users" class="container"></div>

<!-- CHAT -->
<div id="chat">
  <div id="messages"></div>
  <div id="inputBar">
    <input id="msgInput" placeholder="Type a message">
    <button onclick="sendMsg()">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, doc, setDoc, getDocs, collection,
  addDoc, onSnapshot, serverTimestamp, updateDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUfFcZuhV8-vmN9TYvSoe3ZzXHvn_gZwA",
  authDomain: "chat-room-e55bf.firebaseapp.com",
  projectId: "chat-room-e55bf"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let me, other, chatId, typingTimer;

// LOGIN
onAuthStateChanged(auth, async(user)=>{
  if(!user) await signInWithPopup(auth,provider);
  else{
    me = user;
    loadUsers();
    loadStatus();
  }
});

// USERS
async function loadUsers(){
  const snap = await getDocs(collection(db,"users"));
  users.innerHTML="";
  snap.forEach(u=>{
    if(u.id===me.uid) return;
    users.innerHTML+=`
      <div class="user" onclick="openChat('${u.id}','${u.data().name}')">
        <div class="name">${u.data().name}</div>
      </div>`;
  });
}

// STATUS
window.addStatus = async()=>{
  const text = prompt("Enter status");
  if(!text) return;
  await setDoc(doc(db,"status",me.uid),{
    text, time:Date.now(), name:me.displayName
  });
};

function loadStatus(){
  onSnapshot(collection(db,"status"), snap=>{
    statusList.innerHTML="";
    snap.forEach(s=>{
      if(Date.now()-s.data().time>86400000) return;
      statusList.innerHTML+=`
        <div class="user">
          <div class="name">${s.data().name}</div>
          <div class="status">${s.data().text}</div>
        </div>`;
    });
  });
}

// CHAT OPEN
window.openChat=(uid,name)=>{
  other=uid;
  chatId=[me.uid,uid].sort().join("_");
  chatName.innerText=name;
  users.style.display="none";
  chat.style.display="flex";
  listenMessages();
  listenTyping();
};

// CLOSE CHAT
window.closeChat=()=>{
  chat.style.display="none";
  users.style.display="block";
  messages.innerHTML="";
};

// SEND
window.sendMsg=async()=>{
  if(!msgInput.value) return;
  await addDoc(collection(db,"chats",chatId,"messages"),{
    uid:me.uid,
    text:msgInput.value,
    delivered:false,
    seen:false,
    deletedFor:[],
    deletedAll:false,
    time:serverTimestamp()
  });
  msgInput.value="";
};

// LISTEN
function listenMessages(){
  onSnapshot(collection(db,"chats",chatId,"messages"), snap=>{
    messages.innerHTML="";
    snap.forEach(async m=>{
      const d=m.data();
      if(d.deletedAll) return;
      if(d.deletedFor?.includes(me.uid)) return;

      if(d.uid!==me.uid && !d.seen){
        await updateDoc(doc(db,"chats",chatId,"messages",m.id),{seen:true,delivered:true});
      }

      messages.innerHTML+=`
        <div class="msg ${d.uid===me.uid?"me":"other"}">
          ${d.text}
          ${d.uid===me.uid?`
            <span style="color:${d.seen?"#34b7f1":"gray"}">
              ${d.seen?"âœ“âœ“":d.delivered?"âœ“âœ“":"âœ“"}
            </span>`:""}
        </div>`;
    });
    messages.scrollTop=messages.scrollHeight;
  });
}

// TYPING
msgInput.oninput=()=>{
  setDoc(doc(db,"chats",chatId,"typing",me.uid),{typing:true});
  clearTimeout(typingTimer);
  typingTimer=setTimeout(()=>setDoc(doc(db,"chats",chatId,"typing",me.uid),{typing:false}),1000);
};

function listenTyping(){
  onSnapshot(collection(db,"chats",chatId,"typing"), snap=>{
    typing.innerText="";
    snap.forEach(t=>{
      if(t.id!==me.uid && t.data().typing) typing.innerText="typing...";
    });
  });
}

// MENU
window.toggleMenu=()=>menu.style.display=menu.style.display?"":"block";

// CLEAR CHAT
window.clearForMe=async()=>{
  const snap=await getDocs(collection(db,"chats",chatId,"messages"));
  snap.forEach(m=>{
    updateDoc(doc(db,"chats",chatId,"messages",m.id),{
      deletedFor:[...(m.data().deletedFor||[]),me.uid]
    });
  });
  menu.style.display="none";
};

window.clearForAll=async()=>{
  const snap=await getDocs(collection(db,"chats",chatId,"messages"));
  snap.forEach(m=>{
    updateDoc(doc(db,"chats",chatId,"messages",m.id),{deletedAll:true});
  });
  menu.style.display="none";
};
</script>

</body>
</html>
