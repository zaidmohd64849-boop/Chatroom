<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chatroom</title>

<style>
body{margin:0;font-family:Arial;background:#ece5dd}
header{background:#075e54;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center}
.container{padding:10px}
.card{background:#fff;padding:12px;margin-bottom:8px;border-radius:8px}
input{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer}
.logout{background:#fff;color:#075e54}
.user{cursor:pointer}
#chatBox{height:55vh;overflow-y:auto;background:#efeae2;padding:10px}
.msg{padding:8px;margin:5px 0;max-width:70%;border-radius:6px;font-size:14px}
.me{background:#dcf8c6;margin-left:auto}
.other{background:#fff}
.small{font-size:12px;color:gray}
</style>
</head>

<body>

<header>
  <b>Chat App</b>
  <button class="logout" id="logoutBtn">Logout</button>
</header>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <button onclick="login()">Login with Google</button>
</div>

<!-- HOME -->
<div class="container" id="home" style="display:none">
  <input id="search" placeholder="Search users to add..." oninput="searchUsers()">

  <h4>Friend Requests</h4>
  <div id="requests"></div>

  <h4>Your Friends</h4>
  <div id="friends"></div>
</div>

<!-- CHAT -->
<div class="container" id="chatPage" style="display:none">

  <!-- CHAT HEADER -->
  <div class="chatHeader" style="
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#075e54;
    color:white;
    padding:10px;
  ">
    <div>
      <div id="chatName"></div>
      <small id="status"></small>
    </div>

    <div>
      <button onclick="clearChat()" style="
        background:#075e54;
        color:white;
        border:none;
        margin-right:6px;
      ">Clear</button>

      <button onclick="goBack()" style="
        background:#075e54;
        color:white;
        border:none;
      ">â¬…</button>
    </div>
  </div>

  <!-- MESSAGES -->
  <div id="chatBox" style="padding:10px;"></div>

  <!-- INPUT -->
  <input id="msgInput"
         placeholder="Type message..."
         onkeydown="sendMsg(event)"
         style="width:100%;padding:10px;">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, getDocs,
  collection, addDoc, onSnapshot, query, orderBy, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyBUfFcZuhV8-vmN9TYvSoe3ZzXHvn_gZwA",
  authDomain:"chat-room-e55bf.firebaseapp.com",
  projectId:"chat-room-e55bf"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const provider=new GoogleAuthProvider();

let me,currentFriend=null;

// AUTH
onAuthStateChanged(auth,async u=>{
  if(u){
    me=u;
    loginBox.style.display="none";
    home.style.display="block";

    await setDoc(doc(db,"users",me.uid),{
      name:me.displayName,
      email:me.email
    },{merge:true});

    loadFriends();
    loadRequests();
  }
});

window.login=()=>signInWithPopup(auth,provider);
logoutBtn.onclick=()=>signOut(auth);

//// FRIEND SYSTEM ///////

// SEARCH USERS (ADD FRIEND REQUEST)
window.searchUsers = async ()=>{
  const q = search.value.toLowerCase();
  friends.innerHTML="";
  if(!q) return;

  const snap = await getDocs(collection(db,"users"));
  snap.forEach(u=>{
    if(u.id===me.uid) return;
    if(u.data().name.toLowerCase().includes(q)){
      friends.innerHTML+=`
        <div class="card">
          <b>${u.data().name}</b>
          <button onclick="sendRequest('${u.id}','${u.data().name}')">Add</button>
        </div>`;
    }
  });
};

// SEND REQUEST
window.sendRequest = async (uid,name)=>{
  await setDoc(doc(db,"requests",uid,"list",me.uid),{
    name:me.displayName
  });
  alert("Request sent");
  search.value="";
};

// LOAD REQUESTS
async function loadRequests(){
  requests.innerHTML="";
  const snap = await getDocs(collection(db,"requests",me.uid,"list"));
  snap.forEach(r=>{
    requests.innerHTML+=`
      <div class="card">
        <b>${r.data().name}</b>
        <button onclick="acceptRequest('${r.id}','${r.data().name}')">
          Accept
        </button>
      </div>`;
  });
}

// ACCEPT REQUEST
window.acceptRequest = async (uid,name)=>{
  await setDoc(doc(db,"friends",me.uid,"list",uid),{name});
  await setDoc(doc(db,"friends",uid,"list",me.uid),{name:me.displayName});
  await deleteDoc(doc(db,"requests",me.uid,"list",uid));
  loadFriends();
  loadRequests();
};

// LOAD FRIENDS
async function loadFriends(){
  friends.innerHTML="";
  const snap = await getDocs(collection(db,"friends",me.uid,"list"));
  snap.forEach(f=>{
    friends.innerHTML+=`
      <div class="card user" onclick="openChat('${f.id}')">
        <b>${f.data().name}</b>
      </div>`;
  });
}

//// CHAT ///////

function chatId(){
  return me.uid<currentFriend?me.uid+currentFriend:currentFriend+me.uid;
}

window.openChat = async uid=>{
  const f = await getDoc(doc(db,"friends",me.uid,"list",uid));
  if(!f.exists()) return alert("Add friend first");

  currentFriend=uid;
  home.style.display="none";
  chatPage.style.display="block";
  loadChat();
};

window.goBack=()=>{
  chatPage.style.display="none";
  home.style.display="block";
};

function loadChat(){
  onSnapshot(
    query(collection(db,"chats",chatId(),"messages"),orderBy("time")),
    snap=>{
      chatBox.innerHTML="";
      snap.forEach(m=>{
        chatBox.innerHTML+=`
          <div class="msg ${m.data().uid===me.uid?'me':'other'}">
            ${m.data().text}
          </div>`;
      });
      chatBox.scrollTop=chatBox.scrollHeight;
    }
  );
}

window.sendMsg = async e=>{
  if(e.key==="Enter" && msgInput.value){
    await addDoc(collection(db,"chats",chatId(),"messages"),{
      text:msgInput.value,
      uid:me.uid,
      time:Date.now()
    });
    msgInput.value="";
  }
};
  window.clearChat = () => {
  if (confirm("Clear chat? (sirf aapke liye)")) {
    document.getElementById("chatBox").innerHTML = "";
  }
};
</script>

</body>
</html>
