<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat App</title>

<style>
body{margin:0;font-family:Arial;background:#ece5dd}
header{background:#075e54;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center}
.container{padding:10px}
.card{background:#fff;padding:12px;margin-bottom:8px;border-radius:8px}
input{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
.logout{background:#fff;color:#075e54}
.user{cursor:pointer}
#chatBox{height:55vh;overflow-y:auto;background:#efeae2;padding:10px}
.msg{padding:8px;margin:5px 0;max-width:70%;border-radius:6px;font-size:14px}
.me{background:#dcf8c6;margin-left:auto}
.other{background:#fff}
.small{font-size:12px;color:gray}
</style>
</head>

<body>

<header>
  <b>Chat App</b>
  <button class="logout" id="logoutBtn">Logout</button>
</header>

<div class="container" id="loginBox">
  <button onclick="login()">Login with Google</button>
</div>

<div class="container" id="home" style="display:none">
  <input id="search" placeholder="Search friend..." oninput="filterUsers()">
  <div class="card" onclick="addStatus()">➕ My Status<div class="small">Tap to add status</div></div>
  <div id="users"></div>
</div>

<div class="container" id="chatPage" style="display:none">
  <button onclick="goBack()">⬅ Back</button>
  <button onclick="clearChatMe()">Clear for me</button>
  <button onclick="clearChatAll()">Clear for everyone</button>
  <div id="typing" class="small"></div>
  <div id="chatBox"></div>
  <input id="msgInput" placeholder="Type message..."
    onkeydown="sendMsg(event)"
    oninput="typingStatus(true)"
    onblur="typingStatus(false)">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDocs, getDoc,
  collection, addDoc, onSnapshot, query, orderBy, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyBUfFcZuhV8-vmN9TYvSoe3ZzXHvn_gZwA",
  authDomain:"chat-room-e55bf.firebaseapp.com",
  projectId:"chat-room-e55bf"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const provider=new GoogleAuthProvider();

let me,currentFriend=null,typingRef;

// AUTH
onAuthStateChanged(auth,async u=>{
  if(u){
    me=u;
    loginBox.style.display="none";
    home.style.display="block";
    await setDoc(doc(db,"users",me.uid),{
      name:me.displayName,
      email:me.email,
      lastSeen:Date.now()
    },{merge:true});
    loadUsers();
  }
});

window.login=()=>signInWithPopup(auth,provider);
logoutBtn.onclick=()=>signOut(auth);

// USERS
async function loadUsers(){
  const snap=await getDocs(collection(db,"users"));
  users.innerHTML="";
  snap.forEach(u=>{
    if(u.id===me.uid) return;
    users.innerHTML+=`
      <div class="card user" onclick="openChat('${u.id}')">
        <b>${u.data().name}</b>
      </div>`;
  });
}

window.filterUsers=()=>{
  const q=search.value.toLowerCase();
  [...users.children].forEach(c=>{
    c.style.display=c.innerText.toLowerCase().includes(q)?"block":"none";
  });
};

// CHAT
function chatId(){
  return me.uid<currentFriend?me.uid+currentFriend:currentFriend+me.uid;
}

window.openChat=uid=>{
  currentFriend=uid;
  home.style.display="none";
  chatPage.style.display="block";
  loadChat();
};

window.goBack=()=>{
  chatPage.style.display="none";
  home.style.display="block";
};

// LOAD CHAT
function loadChat(){
  onSnapshot(
    query(collection(db,"chats",chatId(),"messages"),orderBy("time")),
    snap=>{
      chatBox.innerHTML="";
      snap.forEach(m=>{
        if(m.data().deletedFor===me.uid) return;
        chatBox.innerHTML+=`
          <div class="msg ${m.data().uid===me.uid?'me':'other'}">
            ${m.data().text}
            <div class="small">
              ${m.data().uid===me.uid?(m.data().seen?'Seen':'Delivered'):''}
            </div>
          </div>`;
      });
      chatBox.scrollTop=chatBox.scrollHeight;
    }
  );

  onSnapshot(doc(db,"typing",chatId()),s=>{
    if(s.exists() && s.data().uid!==me.uid && s.data().typing)
      typing.innerText="typing...";
    else typing.innerText="";
  });
}

// SEND
window.sendMsg=async e=>{
  if(e.key==="Enter" && msgInput.value){
    await addDoc(collection(db,"chats",chatId(),"messages"),{
      text:msgInput.value,
      uid:me.uid,
      time:Date.now(),
      seen:false
    });
    msgInput.value="";
    typingStatus(false);
  }
};

// TYPING
window.typingStatus=async state=>{
  if(!currentFriend) return;
  typingRef=doc(db,"typing",chatId());
  await setDoc(typingRef,{uid:me.uid,typing:state});
};

// CLEAR CHAT
window.clearChatMe=async()=>{
  const snap=await getDocs(collection(db,"chats",chatId(),"messages"));
  snap.forEach(async m=>{
    await setDoc(doc(db,"chats",chatId(),"messages",m.id),
      {deletedFor:me.uid},{merge:true});
  });
};

window.clearChatAll=async()=>{
  const snap=await getDocs(collection(db,"chats",chatId(),"messages"));
  snap.forEach(async m=>{
    await deleteDoc(doc(db,"chats",chatId(),"messages",m.id));
  });
};

// STATUS
window.addStatus=async()=>{
  const t=prompt("Enter status");
  if(!t) return;
  await setDoc(doc(db,"status",me.uid),{
    text:t,time:Date.now(),name:me.displayName
  });
};
</script>

</body>
</html>
