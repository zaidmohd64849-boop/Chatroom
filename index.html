<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Social Media App</title>

<style>
body{
  font-family: Arial;
  background:#fafafa;
  margin:0;
}
header{
  background:#fff;
  padding:10px;
  border-bottom:1px solid #ddd;
  display:flex;
  justify-content:space-between;
}
.container{
  max-width:600px;
  margin:auto;
  padding:10px;
}
.card{
  background:#fff;
  padding:10px;
  border:1px solid #ddd;
  margin-bottom:10px;
  border-radius:5px;
}
button{
  padding:5px 10px;
  cursor:pointer;
}
.follow-btn{
  background:#3897f0;
  color:white;
  border:none;
  border-radius:3px;
}
.unfollow{
  background:#aaa;
}
.post{
  border-top:1px solid #eee;
  padding-top:5px;
}
</style>
</head>

<body>

<header>
  <b>ðŸ”¥ My Social Media App</b>
  <button id="logout">Logout</button>
</header>

<div class="container">

<div class="card">
  <h3 id="myName"></h3>
  <input id="bio" placeholder="Bio">
  <button onclick="saveBio()">Save Bio</button>
  <p>
    Followers: <span id="followers">0</span> |
    Following: <span id="following">0</span>
  </p>
</div>

<div class="card">
  <input id="postText" placeholder="What's on your mind?" style="width:100%">
  <button onclick="addPost()">Post</button>
</div>

<div id="posts"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
 getAuth, GoogleAuthProvider,
 signInWithPopup, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

import {
 getFirestore, doc, setDoc, getDoc,
 updateDoc, arrayUnion, arrayRemove,
 addDoc, collection, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey: "YOUR_API_KEY",
 authDomain: "YOUR_PROJECT.firebaseapp.com",
 projectId: "YOUR_PROJECT"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const provider = new GoogleAuthProvider();

let currentUser;

// LOGIN
onAuthStateChanged(auth, async(user)=>{
 if(!user){
   signInWithPopup(auth, provider);
 }else{
   currentUser = user;
   document.getElementById("myName").innerText = user.displayName;

   const ref = doc(db,"users",user.uid);
   const snap = await getDoc(ref);

   if(!snap.exists()){
     await setDoc(ref,{
       name:user.displayName,
       bio:"",
       followers:[],
       following:[]
     });
   }
   loadProfile();
   loadPosts();
 }
});

// LOGOUT
logout.onclick=()=>signOut(auth);

// SAVE BIO
async function saveBio(){
 const ref = doc(db,"users",currentUser.uid);
 await updateDoc(ref,{ bio: bio.value });
 alert("Bio updated");
}

// LOAD PROFILE
async function loadProfile(){
 const snap = await getDoc(doc(db,"users",currentUser.uid));
 const d = snap.data();
 bio.value = d.bio;
 followers.innerText = d.followers.length;
 following.innerText = d.following.length;
}

// ADD POST
async function addPost(){
 if(!postText.value) return;
 await addDoc(collection(db,"posts"),{
   text:postText.value,
   userId:currentUser.uid,
   userName:currentUser.displayName,
   time:Date.now()
 });
 postText.value="";
}

// LOAD POSTS
function loadPosts(){
 onSnapshot(collection(db,"posts"),(snap)=>{
   posts.innerHTML="";
   snap.forEach(docu=>{
     const p = docu.data();
     posts.innerHTML += `
     <div class="card post">
       <b>${p.userName}</b>
       <p>${p.text}</p>
       ${p.userId!==currentUser.uid
         ? `<button onclick="toggleFollow('${p.userId}')">Follow / Unfollow</button>`
         : ""}
     </div>`;
   });
 });
}

// FOLLOW / UNFOLLOW
window.toggleFollow = async (uid)=>{
 const myRef = doc(db,"users",currentUser.uid);
 const userRef = doc(db,"users",uid);

 const mySnap = await getDoc(myRef);
 const isFollowing = mySnap.data().following.includes(uid);

 if(isFollowing){
   await updateDoc(myRef,{ following:arrayRemove(uid) });
   await updateDoc(userRef,{ followers:arrayRemove(currentUser.uid) });
 }else{
   await updateDoc(myRef,{ following:arrayUnion(uid) });
   await updateDoc(userRef,{ followers:arrayUnion(currentUser.uid) });
 }
 loadProfile();
}
</script>

</body>
</html>
