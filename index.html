<!DOCTYPE html>
<html>
<head>
  <title>Mini Social App</title>
  <meta charset="UTF-8" />
  <style>
    body { font-family: Arial; padding: 15px; }
    textarea, input { width: 100%; margin-top: 5px; }
    button { margin-top: 5px; }
    .post {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
    }
    .dp {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #4f46e5;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 10px;
    }
    .comment {
      margin-left: 10px;
      font-size: 14px;
    }
    .del {
      color: red;
      cursor: pointer;
      margin-left: 5px;
    }
  </style>
</head>
<body>
<centre>
<h2>My Social Media App</h2>

<button id="loginBtn">Login with Google</button>
<button id="logoutBtn" style="display:none;">Logout</button>

<hr>

<div id="profile" style="display:none;">
  <div class="dp" id="dp"></div>
  <h3 id="userName"></h3>

  <textarea id="bioInput" placeholder="Write your bio"></textarea>
  <button id="saveBio">Save Bio</button>
</div>

<hr>

<div id="postSection" style="display:none;">
  <textarea id="postText" placeholder="What's on your mind?"></textarea>
  <button id="addPost">Post</button>

  <h3>Posts</h3>
  <div id="posts"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider,
    signInWithPopup, signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc,
    collection, addDoc, onSnapshot,
    updateDoc, arrayUnion, arrayRemove,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBUfFcZuhV8-vmN9TYvSoe3ZzXHvn_gZwA",
    authDomain: "chat-room-e55bf.firebaseapp.com",
    projectId: "chat-room-e55bf",
    appId: "1:653408545862:web:c3c04443d67a55f0a6ae47"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  loginBtn.onclick = () => signInWithPopup(auth, provider);
  logoutBtn.onclick = () => signOut(auth);

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    loginBtn.style.display = "none";
    logoutBtn.style.display = "block";
    profile.style.display = "block";
    postSection.style.display = "block";

    userName.innerText = user.displayName;
    dp.innerText = user.displayName[0].toUpperCase();

    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);
    if (!snap.exists()) {
      await setDoc(userRef, { name: user.displayName, bio: "" });
    } else {
      bioInput.value = snap.data().bio || "";
    }

    saveBio.onclick = async () => {
      await updateDoc(userRef, { bio: bioInput.value });
      alert("Bio saved");
    };

    addPost.onclick = async () => {
      if (!postText.value) return;
      await addDoc(collection(db, "posts"), {
        text: postText.value,
        userName: user.displayName,
        uid: user.uid,
        likes: 0,
        likedBy: []
      });
      postText.value = "";
    };

    onSnapshot(collection(db, "posts"), (snap) => {
      posts.innerHTML = "";
      snap.forEach((d) => {
        const p = d.data();
        const liked = p.likedBy.includes(user.uid);

        posts.innerHTML += `
          <div class="post">
            <b>${p.userName}</b>
            <p>${p.text}</p>

            <button onclick="likePost('${d.id}', ${liked})">
              ${liked ? "Unlike" : "Like"} (${p.likes})
            </button>

            <div>
              <input id="c-${d.id}" placeholder="Write comment" />
              <button onclick="addComment('${d.id}')">Comment</button>
            </div>

            <div id="comments-${d.id}"></div>
          </div>
        `;

        const cRef = collection(db, "posts", d.id, "comments");
        onSnapshot(cRef, (cs) => {
          const cDiv = document.getElementById("comments-" + d.id);
          cDiv.innerHTML = "";
          cs.forEach(c => {
            const cd = c.data();
            const delBtn = cd.uid === user.uid
              ? `<span class="del" onclick="deleteComment('${d.id}','${c.id}')">‚ùå</span>`
              : "";

            cDiv.innerHTML += `
              <div class="comment">
                üí¨ <b>${cd.userName}</b>: ${cd.text} ${delBtn}
              </div>
            `;
          });
        });
      });
    });
  });

  window.likePost = async (id, liked) => {
    await updateDoc(doc(db, "posts", id), {
      likedBy: liked ? arrayRemove(auth.currentUser.uid)
                     : arrayUnion(auth.currentUser.uid),
      likes: liked ? -1 : 1
    });
  };

  window.addComment = async (postId) => {
    const input = document.getElementById("c-" + postId);
    if (!input.value) return;

    await addDoc(collection(db, "posts", postId, "comments"), {
      text: input.value,
      userName: auth.currentUser.displayName,
      uid: auth.currentUser.uid
    });
    input.value = "";
  };

  window.deleteComment = async (postId, commentId) => {
    await deleteDoc(doc(db, "posts", postId, "comments", commentId));
  };
</script>
</centre>
</body>
</html>
