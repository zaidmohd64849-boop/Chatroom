<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Clone</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#ece5dd;
  max-width:480px;
  margin:auto;
  border-left:1px solid #ddd;
  border-right:1px solid #ddd;
  height:100vh;
  overflow:hidden;
}

/* HEADER */
header{
  background:#075e54;
  color:white;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* LOGIN */
#login{
  display:flex;
  height:100vh;
  justify-content:center;
  align-items:center;
}
#login button{
  background:#25d366;
  border:none;
  color:white;
  padding:14px 20px;
  font-size:16px;
  border-radius:30px;
}

/* MAIN */
.container{
  padding:10px;
  overflow-y:auto;
  height:calc(100vh - 60px);
}

.user{
  background:white;
  padding:10px;
  border-radius:10px;
  margin-bottom:6px;
  cursor:pointer;
}

.name{font-weight:600}
.status{font-size:12px;color:gray}

/* SEARCH */
#search{
  width:100%;
  padding:10px;
  border-radius:20px;
  border:none;
  margin-bottom:10px;
}

/* CHAT */
#chat{
  display:none;
  flex-direction:column;
  height:calc(100vh - 60px);
}

#messages{
  flex:1;
  padding:10px;
  overflow-y:auto;
}

.msg{
  max-width:70%;
  padding:8px 12px;
  border-radius:10px;
  margin-bottom:6px;
}

.me{background:#dcf8c6;margin-left:auto}
.other{background:white}

.msg span{
  font-size:11px;
  float:right;
  margin-left:6px;
}

#inputBar{
  display:flex;
  padding:6px;
  background:#f0f0f0;
}

#inputBar input{
  flex:1;
  padding:10px;
  border:none;
  border-radius:20px;
}

#inputBar button{
  background:#25d366;
  border:none;
  color:white;
  padding:10px 16px;
  border-radius:20px;
  margin-left:6px;
}
</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="login">
  <button onclick="login()">Login with Google</button>
</div>

<!-- APP -->
<div id="app" style="display:none">

<header>
  <b>WhatsApp Clone</b>
  <button onclick="logout()" style="background:white;color:#075e54;border:none;border-radius:20px;padding:6px 12px">
    Logout
  </button>
</header>

<div id="main" class="container">

  <!-- SEARCH -->
  <input id="search" placeholder="Search friend..." oninput="searchUser()">

  <!-- STATUS -->
  <div class="user" onclick="addStatus()">
    <div class="name">➕ My Status</div>
    <div class="status">Tap to add status</div>
  </div>
  <div id="statusList"></div>

  <!-- USERS -->
  <div id="users"></div>
</div>

<!-- CHAT -->
<div id="chat">
  <div id="messages"></div>
  <div id="inputBar">
    <input id="msgInput" placeholder="Type a message">
    <button onclick="sendMsg()">Send</button>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, GoogleAuthProvider,
  signInWithPopup, signOut, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, doc, setDoc, getDocs, collection,
  addDoc, onSnapshot, serverTimestamp, updateDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUfFcZuhV8-vmN9TYvSoe3ZzXHvn_gZwA",
  authDomain: "chat-room-e55bf.firebaseapp.com",
  projectId: "chat-room-e55bf"
};

const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth(appFirebase);
const db = getFirestore(appFirebase);
const provider = new GoogleAuthProvider();

let me, allUsers=[], chatId;

// AUTH STATE
onAuthStateChanged(auth,(user)=>{
  if(user){
    me=user;
    login.style.display="none";
    app.style.display="block";
    saveUser();
    loadUsers();
    loadStatus();
  }else{
    app.style.display="none";
    login.style.display="flex";
  }
});

// LOGIN
window.login = async()=>{
  await signInWithPopup(auth,provider);
};

// LOGOUT
window.logout = async()=>{
  await signOut(auth);
};

// SAVE USER
async function saveUser(){
  await setDoc(doc(db,"users",me.uid),{
    name:me.displayName,
    email:me.email
  },{merge:true});
}

// USERS
async function loadUsers(){
  const snap=await getDocs(collection(db,"users"));
  allUsers=[];
  snap.forEach(u=>{
    if(u.id!==me.uid) allUsers.push({id:u.id,...u.data()});
  });
  renderUsers(allUsers);
}

function renderUsers(list){
  users.innerHTML="";
  list.forEach(u=>{
    users.innerHTML+=`
      <div class="user" onclick="openChat('${u.id}','${u.name}')">
        <div class="name">${u.name}</div>
      </div>`;
  });
}

window.searchUser=()=>{
  const q=search.value.toLowerCase();
  renderUsers(allUsers.filter(u=>u.name.toLowerCase().includes(q)));
};

// STATUS
window.addStatus=async()=>{
  const text=prompt("Enter status");
  if(!text) return;
  await setDoc(doc(db,"status",me.uid),{
    text,time:Date.now(),name:me.displayName
  });
};

function loadStatus(){
  onSnapshot(collection(db,"status"),snap=>{
    statusList.innerHTML="";
    snap.forEach(s=>{
      if(Date.now()-s.data().time<86400000){
        statusList.innerHTML+=`
          <div class="user">
            <div class="name">${s.data().name}</div>
            <div class="status">${s.data().text}</div>
          </div>`;
      }
    });
  });
}

// CHAT
window.openChat=(uid,name)=>{
  chatId=[me.uid,uid].sort().join("_");
  main.style.display="none";
  chat.style.display="flex";
  listenMessages();
};

window.sendMsg=async()=>{
  if(!msgInput.value) return;
  await addDoc(collection(db,"chats",chatId,"messages"),{
    uid:me.uid,text:msgInput.value,
    delivered:false,seen:false,
    time:serverTimestamp()
  });
  msgInput.value="";
};

function listenMessages(){
  onSnapshot(collection(db,"chats",chatId,"messages"),snap=>{
    messages.innerHTML="";
    snap.forEach(async m=>{
      const d=m.data();
      if(d.uid!==me.uid && !d.seen){
        await updateDoc(doc(db,"chats",chatId,"messages",m.id),
        {seen:true,delivered:true});
      }
      messages.innerHTML+=`
        <div class="msg ${d.uid===me.uid?"me":"other"}">
          ${d.text}
          ${d.uid===me.uid?`
            <span style="color:${d.seen?"#34b7f1":"gray"}">
              ${d.seen?"✓✓":d.delivered?"✓✓":"✓"}
            </span>`:""}
        </div>`;
    });
    messages.scrollTop=messages.scrollHeight;
  });
}
</script>

</body>
</html>
