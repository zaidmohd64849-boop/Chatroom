<!DOCTYPE html>
<html>
<head>
  <title>Mini Social App â€“ Chat</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial; padding: 10px; }
    button { margin: 3px; }
    .user { border:1px solid #ccc; padding:5px; margin:5px 0; cursor:pointer; }
    .chatBox {
      border:1px solid #000;
      height:250px;
      overflow-y:auto;
      padding:5px;
      margin-top:5px;
    }
    .me { text-align:right; color:blue; }
    .other { text-align:left; color:green; }
  </style>
</head>
<body>

<h2>Chat App</h2>

<button id="loginBtn">Login with Google</button>
<button id="logoutBtn" style="display:none;">Logout</button>

<hr>

<div id="usersDiv" style="display:none;">
  <h3>Users</h3>
  <div id="users"></div>
</div>

<hr>

<div id="chatDiv" style="display:none;">
  <h3 id="chatWith"></h3>
  <div class="chatBox" id="messages"></div>
  <input id="msgInput" placeholder="Type message">
  <button id="sendMsg">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getAuth, GoogleAuthProvider,
  signInWithPopup, signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc,
  collection, addDoc, onSnapshot,
  query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUfFcZuhV8-vmN9TYvSoe3ZzXHvn_gZwA",
  authDomain: "chat-room-e55bf.firebaseapp.com",
  projectId: "chat-room-e55bf",
  appId: "1:653408545862:web:c3c04443d67a55f0a6ae47"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let currentChatId = "";
let chatUserName = "";

loginBtn.onclick = () => signInWithPopup(auth, provider);
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {
  if (!user) return;

  loginBtn.style.display="none";
  logoutBtn.style.display="block";
  usersDiv.style.display="block";

  await setDoc(doc(db,"users",user.uid),{
    name:user.displayName
  },{merge:true});

  onSnapshot(collection(db,"users"), snap=>{
    users.innerHTML="";
    snap.forEach(d=>{
      if(d.id===user.uid) return;
      users.innerHTML+=`
        <div class="user" onclick="openChat('${d.id}','${d.data().name}')">
          ${d.data().name}
        </div>`;
    });
  });
});

window.openChat = (uid,name)=>{
  chatDiv.style.display="block";
  chatWith.innerText="Chat with "+name;
  chatUserName=name;

  const me=auth.currentUser.uid;
  currentChatId = me<uid ? me+"_"+uid : uid+"_"+me;

  const q=query(
    collection(db,"chats",currentChatId,"messages"),
    orderBy("time")
  );

  onSnapshot(q,snap=>{
    messages.innerHTML="";
    snap.forEach(m=>{
      const d=m.data();
      const cls=d.sender===me?"me":"other";
      messages.innerHTML+=`<div class="${cls}">${d.text}</div>`;
    });
    messages.scrollTop=messages.scrollHeight;
  });
};

sendMsg.onclick = async ()=>{
  if(!msgInput.value) return;
  await addDoc(
    collection(db,"chats",currentChatId,"messages"),
    {
      text:msgInput.value,
      sender:auth.currentUser.uid,
      time:serverTimestamp()
    }
  );
  msgInput.value="";
};
</script>

</body>
</html>
