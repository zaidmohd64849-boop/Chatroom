<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Social Media App</title>

<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#f2f2f2;
}
header{
  background:#ff4d4d;
  color:white;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{
  padding:10px;
}
.card{
  background:white;
  padding:12px;
  margin-bottom:10px;
  border-radius:10px;
}
button{
  padding:6px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.follow{
  background:#0095f6;
  color:white;
}
.unfollow{
  background:#ccc;
}
.logout{
  background:white;
  color:#ff4d4d;
}
.user{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.small{
  font-size:13px;
  color:gray;
}
</style>
</head>

<body>

<header>
  <h3>ðŸ”¥ My Social Media App</h3>
  <button class="logout" id="logoutBtn">Logout</button>
</header>

<div class="container">

<div class="card" id="profileCard">
  <h3 id="myName">Loading...</h3>
  <p class="small">
    Followers: <span id="followers">0</span> |
    Following: <span id="following">0</span>
  </p>
</div>

<div class="card">
  <h4>All Users</h4>
  <div id="usersList">Loading...</div>
</div>

</div>

<!-- ðŸ”¥ Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUfFcZuhV8-vmN9TYvSoe3ZzXHvn_gZwA",
  authDomain: "chat-room-e55bf.firebaseapp.com",
  projectId: "chat-room-e55bf"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let currentUser;

// ðŸ” LOGIN
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    await signInWithPopup(auth, provider);
  }else{
    currentUser = user;
    saveUser();
    loadProfile();
    loadUsers();
  }
});

// ðŸ’¾ SAVE USER
async function saveUser(){
  await setDoc(doc(db,"users",currentUser.uid),{
    name: currentUser.displayName,
    email: currentUser.email
  },{merge:true});
}

// ðŸ‘¤ PROFILE
async function loadProfile(){
  document.getElementById("myName").innerText = currentUser.displayName;

  const followers = await getDocs(collection(db,"users",currentUser.uid,"followers"));
  const following = await getDocs(collection(db,"users",currentUser.uid,"following"));

  document.getElementById("followers").innerText = followers.size;
  document.getElementById("following").innerText = following.size;
}

// ðŸ‘¥ LOAD USERS
async function loadUsers(){
  const usersSnap = await getDocs(collection(db,"users"));
  const box = document.getElementById("usersList");
  box.innerHTML = "";

  usersSnap.forEach(async(u)=>{
    if(u.id === currentUser.uid) return;

    const isFollow = await getDoc(doc(db,"users",currentUser.uid,"following",u.id));
    const btnClass = isFollow.exists() ? "unfollow" : "follow";
    const btnText = isFollow.exists() ? "Unfollow" : "Follow";

    box.innerHTML += `
      <div class="user card">
        <div>
          <b>${u.data().name}</b>
        </div>
        <button class="${btnClass}" onclick="toggleFollow('${u.id}')">
          ${btnText}
        </button>
      </div>
    `;
  });
}

// â¤ï¸ FOLLOW / UNFOLLOW
window.toggleFollow = async (uid)=>{
  const ref = doc(db,"users",currentUser.uid,"following",uid);
  const snap = await getDoc(ref);

  if(snap.exists()){
    await deleteDoc(ref);
    await deleteDoc(doc(db,"users",uid,"followers",currentUser.uid));
  }else{
    await setDoc(ref,{time:Date.now()});
    await setDoc(doc(db,"users",uid,"followers",currentUser.uid),{time:Date.now()});
  }
  loadUsers();
  loadProfile();
};

// ðŸšª LOGOUT
document.getElementById("logoutBtn").onclick = ()=>{
  signOut(auth);
};
</script>

</body>
</html>
